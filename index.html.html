<!DOCTYPE html>
<html lang="de">
<head>
  <!-- set the charset -->
  <meta charset="utf-8">
  <!-- set make the map responsive -->
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- set the title shown in the browser tab -->
  <title>Permafrostkarte Schweizer Alpen (BAFU/WSL)</title>

  <!-- Links to the leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>

  <!-- proj4 für präzise WGS84 -> LV95 (EPSG:2056) Umrechnung -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js" crossorigin="anonymous"></script>

  <!-- Links to the Leaflet.MeasureControl Plugin -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-measure/dist/leaflet-measure.min.js"></script>

  <!-- Links to the Leaflet.Geoman Plugin -->
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free/dist/leaflet-geoman.css" />
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free/dist/leaflet-geoman.min.js"></script>

 <!-- styles for elements html and body: fullscreen  -->
  <style>
    html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
    #mapid { width: 100%; height: 100%; }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font: 12px/1.4 "Segoe UI", Arial, sans-serif;
    }
    .legend-title { font-weight: bold; margin-bottom: 6px; }
    .legend-item { display: flex; align-items: center; margin: 4px 0; }
    .legend-swatch { width: 18px; height: 18px; margin-right: 6px; border: 1px solid #999; }
    .popup-row { margin: 4px 0; }
    .popup-label { font-weight: bold; }
  </style>
</head>
<body>
  <!-- set the div element containing the map -->
  <div id="mapid"></div>

 <script>

  // Create Leaflet map, Koordinaten des Geographischen Zentrum der Schweiz und Zoom so gewählt, damit alle Gebirgszüge der Schweizer Alpen sichtbar sind
  var map = L.map('mapid').setView([46.6, 8.3], 8);

  // Add Basemaps
  // basemap: 1
  var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri'
  });

  // basemap 2:
  var osmDE = L.tileLayer('https://{s}.tile.openstreetmap.de/tiles/osmde/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  });

  // basemap: 3
  var openTopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenTopoMap (CC-BY-SA)'
  });
  esriSat.addTo(map);

  // Basemap Dictionary
  var baseMaps = {
    "Satellitenaufnahme (Esri)": esriSat,
    "Thematische Karte (OSM DE)": osmDE,
    "Topographische Karte (OpenTopoMap)": openTopo
  };

  // Add Layer
  // Permafrost WMS des BAFU/WSL
  var permafrostLayer = L.tileLayer.wms("https://wms.geo.admin.ch/", {
    layers: 'ch.bafu.permafrost',
    format: 'image/png',
    transparent: true,
    version: '1.3.0',
    attribution: '© BAFU / WSL / SLF — Permafrostkarte Schweiz'
  }).addTo(map);

  // Landesgrenzen Schweiz (von Swisstopo)
  var grenzenLayer = L.tileLayer.wms("https://wms.geo.admin.ch/", {
  layers: 'ch.swisstopo.swissboundaries3d-land-flaeche.fill',
  format: 'image/png',
  transparent: true,
  version: '1.3.0',
  opacity: 1,
  attribution: '© Swisstopo'
}).addTo(map);

  // Hillshade Layer (Swisstopo Relief) (Dient nur als Hintergrundlayer für die Neigungswerte und wird deshalb nicht im Overlay Dictionary angezeigt werden
  var hillshade = L.tileLayer(
  "https://wmts.geo.admin.ch/1.0.0/ch.swisstopo.swissalti3d/default/current/3857/{z}/{x}/{y}.png",
  {
    attribution: "© Swisstopo — swissALTI3D",
    maxZoom: 18
  }
).addTo(map);

  // Overlay Dictionary
  var overlayMaps = {
    "Permafrost Schweiz (BAFU/WSL)": permafrostLayer,
    "Landesgrenzen Schweiz (Swisstopo)": grenzenLayer,
  
  };
  // Angabe der Koordinaten und Höhenwerte
  // Koordinatenumrechnung
  proj4.defs("EPSG:2056","+proj=somerc +lat_0=46.95240555555556 +lon_0=7.439583333333333 +k_0=1 +x_0=2600000 +y_0=1200000 +ellps=bessel +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
  function wgs84ToLv95(lat, lon) {
    var p = proj4("EPSG:2056", [lon, lat]);
    return { easting: p[0], northing: p[1] };
  }
  // Höhenangaben [m]
  async function fetchAltitudeMeters(latlng) {
    var lv95 = wgs84ToLv95(latlng.lat, latlng.lng);
    var url = "https://api3.geo.admin.ch/rest/services/height?easting=" + lv95.easting + "&northing=" + lv95.northing;
    var res = await fetch(url);
    if (!res.ok) throw new Error("Elevation API error");
    var data = await res.json();
    return (typeof data.height !== 'undefined') ? Math.round(data.height) : null;
  }

  // Neigungsangaben [°]
async function fetchSlopeDegrees(latlng) {
    var lv95 = wgs84ToLv95(latlng.lat, latlng.lng);

    // kleine Offsets in Metern
    var offset = 10;

    async function getHeight(easting, northing) {
        var url = "https://api3.geo.admin.ch/rest/services/height?easting=" + easting + "&northing=" + northing;
        var res = await fetch(url);
        var data = await res.json();
        return (typeof data.height !== 'undefined') ? data.height : null;
    }

    var hCenter = await getHeight(lv95.easting, lv95.northing);
    var hNorth  = await getHeight(lv95.easting, lv95.northing + offset);
    var hEast   = await getHeight(lv95.easting + offset, lv95.northing);

    if (hCenter === null || hNorth === null || hEast === null) return null;

    // Gradienten
    var dzdx = (hEast - hCenter) / offset;
    var dzdy = (hNorth - hCenter) / offset;

    // Steigung = arctan(√(dzdx² + dzdy²))
    var slopeRad = Math.atan(Math.sqrt(dzdx*dzdx + dzdy*dzdy));
    var slopeDeg = slopeRad * 180 / Math.PI;

    return slopeDeg.toFixed(1);
}

  // popup-function
  // Flag, ob ein Leaflet-Tool aktiv ist, damit die popups nicht beim nutzen der Tools ständig aufploppen
  var toolActive = false;

  // Geoman Events: Toolstatus setzen
  map.on('pm:drawstart', function() {
    toolActive = true;
  });
  map.on('pm:drawend', function() {
    toolActive = false;
  });
  map.on('pm:globaleditmodetoggled', function(e) {
    toolActive = e.enabled;
  });
  map.on('pm:globaldragmodetoggled', function(e) {
    toolActive = e.enabled;
  });

  // popup-Kästchen
map.on('click', async function(e) {
    if (toolActive) return;
    try {
        var altitude = await fetchAltitudeMeters(e.latlng);
        var slope = await fetchSlopeDegrees(e.latlng);

        var content = "<div class='popup-row'><span class='popup-label'>Breitengrad:</span> " + e.latlng.lat.toFixed(5) + "</div>"
            + "<div class='popup-row'><span class='popup-label'>Längengrad:</span> " + e.latlng.lng.toFixed(5) + "</div>"
            + "<div class='popup-row'><span class='popup-label'>Höhe[m]:</span> " + (altitude !== null ? altitude : "n/a") + "</div>"
            + "<div class='popup-row'><span class='popup-label'>Neigung[°]:</span> " + (slope !== null ? slope : "n/a") + "</div>";

        L.popup({ maxWidth: 320 }).setLatLng(e.latlng).setContent(content).openOn(map);
    } catch (err) {
        L.popup({ maxWidth: 320 }).setLatLng(e.latlng).setContent("Höhe/Neigung konnte nicht geladen werden.").openOn(map);
        console.error(err);
    }
});


  // Controls
  L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: false }).addTo(map);
  L.control.scale({ metric: true, imperial: false }).addTo(map);

  // Legende

  var legend = L.control({ position: 'bottomright' });
  legend.onAdd = function () {
  var div = L.DomUtil.create('div', 'legend');
  div.innerHTML =
    '<div class="legend-title">Permafrost-Wahrscheinlichkeit (BAFU/WSL) ▼</div>' +
    '<div class="legend-content">' +
    '<div class="legend-item"><span class="legend-swatch" style="background:#6a1b9a"></span> Permafrost flächenhaft wahrscheinlich, z.T. große Mächtigkeiten bis über 100m </div>' +
    '<div class="legend-item"><span class="legend-swatch" style="background:#c2185b"></span> Permafrost flächenhaft wahrscheinlich, Mächtigkeit zunehmend </div>' +
    '<div class="legend-item"><span class="legend-swatch" style="background:#e91e63"></span> Permafrost flächenhaft wahrscheinlich </div>' +
    '<div class="legend-item"><span class="legend-swatch" style="background:#ff6600"></span> Permafrost lokal möglich, fleckenhaft bis großflächig </div>' +
    '<div class="legend-item"><span class="legend-swatch" style="background:#ffcc33"></span> Permafrost lokal möglich, fleckenhaft häufig </div>' +
    '<div class="legend-item"><span class="legend-swatch" style="background:#ffff00"></span> Permafrost lokal möglich, fleckenhaft, punktuell </div>' +
    '</div>';

  // Ein-/ausblenden der Legende 
  div.querySelector('.legend-title').onclick = function () {
    var content = div.querySelector('.legend-content');
    if (content.style.display === 'none') {
      content.style.display = 'block';
      this.innerHTML = 'Permafrost-Wahrscheinlichkeit (BAFU/WSL) ▼';
    } else {
      content.style.display = 'none';
      this.innerHTML = 'Permafrost-Wahrscheinlichkeit (BAFU/WSL) ▲';
    }
  };

  return div;
};
legend.addTo(map);

  // Add Plugins
  //  Leaflet.MeasureControl
  L.control.measure({
    position: 'topleft',
    primaryLengthUnit: 'meters',
    secondaryLengthUnit: 'kilometers',
    primaryAreaUnit: 'sqmeters',
    secondaryAreaUnit: 'hectares'
  }).addTo(map);

  // Leaflet.Geoman
  map.pm.addControls({
    position: 'topleft',
    drawMarker: true,
    drawPolygon: true,
    drawPolyline: true,
    drawCircle: true,
    drawRectangle: true,
    editMode: true,
    dragMode: true,
    cutPolygon: true,
    removalMode: true
  });

 </script>
</body>
</html>





